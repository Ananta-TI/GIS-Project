<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analisis Banjir | FloodGuard AI</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- RemixIcon -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">
    
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    
    <style>
        /* Additional styles for map and other components */
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 200px;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }
        .ol-popup:before {
            border-top-color: #cccccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
        }
        .ol-popup-closer:after {
            content: "âœ–";
        }
        
        /* Dark theme adjustments */
        .bg-dark .table-hover tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .dropdown-menu {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        
        .dropdown-item {
            color: #e2e8f0;
        }
        
        .dropdown-item:hover {
            background-color: #4a5568;
            color: #fff;
        }
        
        .pagination .page-link {
            background-color: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        
        .pagination .page-link:hover {
            background-color: #4a5568;
            color: #fff;
        }
        
        .pagination .page-item.active .page-link {
            background-color: #3182ce;
            border-color: #3182ce;
        }
    </style>
</head>
<body>

    <div id="navbar-root"></div>
    
    <!-- Animated Background -->
    <div class="bg-gradient">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>
    
    <!-- Main Dashboard Content -->
    <main class="main-content">
        <div class="container-fluid">
            <div class="d-sm-flex align-items-center justify-content-between mb-4">
                <h1 class="h3 mb-0 text-gray-800">
                    <i class="ri-dashboard-3-line me-2"></i>Dashboard Analisis Banjir Provinsi Riau
                </h1>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-light" id="exportBtn">
                        <i class="ri-download-2-line me-1"></i> Export Data
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-light" id="refreshBtn">
                        <i class="ri-refresh-line me-1"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Metric Cards -->
            <div class="row">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-primary shadow h-100 py-2 metric-card">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                        <i class="ri-alert-fill me-1"></i>Total Titik Banjir
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalFloodPoints">0</div>
                                </div>
                                <div class="col-auto">
                                    <div class="icon-circle bg-primary">
                                        <i class="ri-alert-fill text-white"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-success shadow h-100 py-2 metric-card">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        <i class="ri-rainy-fill me-1"></i>Total Titik Genangan
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalWaterloggingPoints">0</div>
                                </div>
                                <div class="col-auto">
                                    <div class="icon-circle bg-success">
                                        <i class="ri-rainy-fill text-white"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-info shadow h-100 py-2 metric-card">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                        <i class="ri-user-3-fill me-1"></i>Total Korban Jiwa
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalVictims">0</div>
                                </div>
                                <div class="col-auto">
                                    <div class="icon-circle bg-info">
                                        <i class="ri-user-3-fill text-white"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-warning shadow h-100 py-2 metric-card">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        <i class="ri-map-pin-2-fill me-1"></i>Kecamatan Terdampak
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="affectedDistricts">0</div>
                                </div>
                                <div class="col-auto">
                                    <div class="icon-circle bg-warning">
                                        <i class="ri-map-pin-2-fill text-white"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- News Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="ri-newspaper-line me-1"></i>Berita Terkini Banjir
                            </h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="refreshNewsBtn">
                                <i class="ri-refresh-line"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row" id="newsContainer">
                                <!-- News items will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Map Row -->
            <div class="row">
                <!-- Bar Chart: Korban per Lokasi -->
                <div class="col-xl-8 col-lg-7">
                    <div class="card shadow mb-4 chart-card">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="ri-bar-chart-2-line me-1"></i>Jumlah Korban per Lokasi Banjir
                            </h6>
                            <div class="dropdown no-arrow">
                                <a class="dropdown-toggle" href="#" role="button" id="victimsChartDropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="ri-more-2-fill text-gray-400"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in">
                                    <a class="dropdown-item" href="#" id="exportVictimsChart">Export Data</a>
                                    <a class="dropdown-item" href="#" id="viewVictimsChart">Lihat Detail</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="#" id="refreshVictimsChart">Refresh</a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-area">
                                <canvas id="victimsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pie Chart: Klasifikasi Area -->
                <div class="col-xl-4 col-lg-5">
                    <div class="card shadow mb-4 chart-card">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="ri-pie-chart-2-line me-1"></i>Klasifikasi Area di Riau
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-pie pt-4 pb-2">
                                <canvas id="classificationChart"></canvas>
                            </div>
                            <div class="mt-4 text-center small">
                                <span class="mr-2">
                                    <i class="ri-checkbox-blank-circle-fill text-primary"></i> Resiko Tinggi
                                </span>
                                <span class="mr-2">
                                    <i class="ri-checkbox-blank-circle-fill text-success"></i> Resiko Sedang
                                </span>
                                <span class="mr-2">
                                    <i class="ri-checkbox-blank-circle-fill text-info"></i> Resiko Rendah
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table and Mini Map Row -->
            <div class="row">
                <!-- Data Table -->
                <div class="col-lg-8 mb-4">
                    <div class="card shadow mb-4 table-card">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="ri-table-line me-1"></i>Data Detail Titik Banjir & Genangan
                            </h6>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary" id="filterBtn">
                                    <i class="ri-filter-3-line"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="sortBtn">
                                    <i class="ri-sort-asc"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <div class="input-group mb-3">
                                    <span class="input-group-text bg-dark border-secondary text-light">
                                        <i class="ri-search-line"></i>
                                    </span>
                                    <input type="text" id="tableSearch" class="form-control bg-dark border-secondary text-light" placeholder="Cari berdasarkan nama lokasi atau kecamatan...">
                                </div>
                                <table class="table table-bordered table-dark table-hover" id="dataTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>Tipe</th>
                                            <th>Lokasi</th>
                                            <th>Kecamatan</th>
                                            <th>Korban</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dataTableBody">
                                        <!-- Data akan diisi oleh JavaScript -->
                                    </tbody>
                                </table>
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-center">
                                        <!-- Pagination akan diisi oleh JavaScript -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mini Map -->
                <div class="col-lg-4 mb-4">
                    <div class="card shadow mb-4 map-card">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="ri-map-2-line me-1"></i>Peta Sebaran
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div id="miniMap" style="height: 400px; position: relative;">
                                <div class="map-legend">
                                    <h6>Legenda</h6>
                                    <div class="legend-item">
                                        <span class="legend-color" style="background-color: #dc3545;"></span>
                                        <span>Titik Banjir</span>
                                    </div>
                                    <div class="legend-item">
                                        <span class="legend-color" style="background-color: #28a745;"></span>
                                        <span>Titik Genangan</span>
                                    </div>
                                    <div class="legend-item">
                                        <span class="legend-color" style="background-color: #ffc107;"></span>
                                        <span>Area Resiko Tinggi</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- OpenLayers -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    
    <script>
        // Global variables to store data
        let banjirData, genanganData, riauData, newsData, pekanData;
        let allPointData = [];
        let filteredData = [];
        let victimsChart, classificationChart, miniMap;

        document.addEventListener('DOMContentLoaded', async () => {
            // Tampilkan loading spinner
            showLoadingSpinner();
            
            try {
                // --- 1. DATA LOADING ---
                const [banjirRes, genanganRes, riauRes, newsRes, pekanRes] = await Promise.all([
                    fetch('data/banjir.json').then(res => {
                        if (!res.ok) throw new Error('Gagal memuat data banjir');
                        return res.json();
                    }),
                    fetch('data/csvjson.json').then(res => {
                        if (!res.ok) throw new Error('Gagal memuat data genangan');
                        return res.json();
                    }),
                    fetch('data/polygon_riau.json').then(res => {
                        if (!res.ok) throw new Error('Gagal memuat data Riau');
                        return res.json();
                    }),
                    fetch('data/news.json').then(res => {
                        if (!res.ok) throw new Error('Gagal memuat data berita');
                        return res.json();
                    }),
                    fetch('data/pekan.json').then(res => {
                        if (!res.ok) throw new Error('Gagal memuat data Pekanbaru');
                        return res.json();
                    })
                ]);

                // Store data in global variables
                banjirData = banjirRes;
                genanganData = genanganRes;
                riauData = riauRes;
                newsData = newsRes;
                pekanData = pekanRes;

                // --- 2. METRIC CALCULATION ---
                const totalFloodPoints = banjirData.features.length;
                const totalWaterloggingPoints = genanganData.features.length;
                const totalVictims = banjirData.features.reduce((sum, feature) => sum + (feature.properties.Jumlah_Korban || 0), 0);

                const affectedDistrictsSet = new Set();
                banjirData.features.forEach(f => affectedDistrictsSet.add(f.properties.Nama_Pemetaan));
                genanganData.features.forEach(f => affectedDistrictsSet.add(f.properties.kecamatan));
                const affectedDistricts = affectedDistrictsSet.size;

                // --- 3. UPDATE METRIC CARDS ---
                updateMetricCard('totalFloodPoints', totalFloodPoints);
                updateMetricCard('totalWaterloggingPoints', totalWaterloggingPoints);
                updateMetricCard('totalVictims', totalVictims);
                updateMetricCard('affectedDistricts', affectedDistricts);

                // --- 4. POPULATE NEWS SECTION ---
                populateNewsSection();

                // --- 5. CHART GENERATION ---
                // Bar Chart: Korban per Lokasi
                const victimsByLocation = {};
                banjirData.features.forEach(feature => {
                    const location = feature.properties.Nama_Pemetaan;
                    victimsByLocation[location] = (victimsByLocation[location] || 0) + (feature.properties.Jumlah_Korban || 0);
                });

                const victimsCtx = document.getElementById('victimsChart').getContext('2d');
                victimsChart = new Chart(victimsCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(victimsByLocation),
                        datasets: [{
                            label: 'Jumlah Korban',
                            data: Object.values(victimsByLocation),
                            backgroundColor: 'rgba(56, 189, 248, 0.5)',
                            borderColor: 'rgba(56, 189, 248, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });

                // Pie Chart: Klasifikasi Area
                const classificationCount = {};
                riauData.features.forEach(feature => {
                    const classification = feature.properties.STATUS_KOT;
                    classificationCount[classification] = (classificationCount[classification] || 0) + 1;
                });

                const classificationCtx = document.getElementById('classificationChart').getContext('2d');
                classificationChart = new Chart(classificationCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(classificationCount),
                        datasets: [{
                            data: Object.values(classificationCount),
                            backgroundColor: [
                                '#38bdf8', '#10b981', '#06b6d4', '#f59e0b', '#f43f5e', '#818cf8'
                            ],
                            hoverBackgroundColor: ['#0ea5e9', '#059669', '#0891b2', '#d97706', '#e11d48', '#6366f1'],
                            hoverBorderColor: "rgba(234, 236, 244, 1)",
                        }],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    padding: 20
                                }
                            }
                        }
                    }
                });

                // --- 6. DATA TABLE POPULATION ---
                initializeDataTable();

                // --- 7. MINI MAP INITIALIZATION ---
                initializeMiniMap();
                
                // --- 8. EVENT LISTENERS FOR EXPORT AND REFRESH ---
                document.getElementById('exportBtn').addEventListener('click', exportData);
                document.getElementById('refreshBtn').addEventListener('click', refreshData);
                document.getElementById('refreshNewsBtn').addEventListener('click', refreshNews);
                
                // Hide loading spinner
                hideLoadingSpinner();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showErrorNotification('Gagal memuat data dashboard. Silakan coba lagi.');
                hideLoadingSpinner();
            }
        });

        // --- HELPER FUNCTIONS ---

        function populateNewsSection() {
            const newsContainer = document.getElementById('newsContainer');
            newsContainer.innerHTML = '';
            
            // Take only the first 4 news items
            const newsToShow = newsData.slice(0, 4);
            
            newsToShow.forEach(news => {
                const newsItem = document.createElement('div');
                newsItem.className = 'col-md-6 col-lg-3 mb-3';
                newsItem.innerHTML = `
                    <div class="card h-100 bg-dark text-light">
                        <div class="card-body">
                            <h6 class="card-title">${news.title}</h6>
                            <p class="card-text small">${news.description}</p>
                            <a href="${news.url}" target="_blank" class="btn btn-sm btn-outline-primary">Baca Selengkapnya</a>
                        </div>
                        <div class="card-footer text-muted small">
                            <i class="ri-calendar-line me-1"></i>${new Date(news.publishedAt).toLocaleDateString('id-ID')}
                        </div>
                    </div>
                `;
                newsContainer.appendChild(newsItem);
            });
        }

        function initializeDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            const searchInput = document.getElementById('tableSearch');
            const filterBtn = document.querySelector('.ri-filter-3-line').parentElement;
            const sortBtn = document.querySelector('.ri-sort-asc').parentElement;
            
            let currentSortField = 'location';
            let sortDirection = 'asc';
            allPointData = [...banjirData.features, ...genanganData.features];
            filteredData = [...allPointData];

            // Fungsi untuk populate tabel
            const populateTable = (data, page = 1) => {
                const itemsPerPage = 10;
                const startIndex = (page - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedData = data.slice(startIndex, endIndex);
                
                tableBody.innerHTML = '';
                paginatedData.forEach((feature, index) => {
                    const row = document.createElement('tr');
                    const props = feature.properties;
                    const type = props.Nama_Pemetaan ? 'Banjir' : 'Genangan';
                    const location = props.Nama_Pemetaan || props.jalan || '-';
                    const district = props.kecamatan || '-';
                    const victims = props.Jumlah_Korban || '-';
                    const featureIndex = allPointData.indexOf(feature);

                    row.innerHTML = `
                        <td>${type}</td>
                        <td>${location}</td>
                        <td>${district}</td>
                        <td>${victims}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary view-btn" data-index="${featureIndex}">
                                <i class="ri-eye-line"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info map-btn" data-index="${featureIndex}">
                                <i class="ri-map-pin-line"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Update pagination
                updatePagination(data.length, page, itemsPerPage);
                
                // Add event listeners to action buttons
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        showFeatureDetails(allPointData[index]);
                    });
                });
                
                document.querySelectorAll('.map-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        showFeatureOnMap(allPointData[index]);
                    });
                });
            };

            // Fungsi untuk update pagination
            const updatePagination = (totalItems, currentPage, itemsPerPage) => {
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                const pagination = document.querySelector('.pagination');
                pagination.innerHTML = '';
                
                // Previous button
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
                pagination.appendChild(prevLi);
                
                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                    pagination.appendChild(li);
                }
                
                // Next button
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
                pagination.appendChild(nextLi);
                
                // Add event listeners to pagination links
                document.querySelectorAll('.page-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const page = parseInt(this.getAttribute('data-page'));
                        if (page > 0 && page <= totalPages) {
                            populateTable(filteredData, page);
                        }
                    });
                });
            };

            // Fungsi untuk sorting data
            const sortData = (field) => {
                if (currentSortField === field) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortField = field;
                    sortDirection = 'asc';
                }
                
                filteredData.sort((a, b) => {
                    let aVal, bVal;
                    
                    switch(field) {
                        case 'type':
                            aVal = a.properties.Nama_Pemetaan ? 'Banjir' : 'Genangan';
                            bVal = b.properties.Nama_Pemetaan ? 'Banjir' : 'Genangan';
                            break;
                        case 'location':
                            aVal = a.properties.Nama_Pemetaan || a.properties.jalan || '';
                            bVal = b.properties.Nama_Pemetaan || b.properties.jalan || '';
                            break;
                        case 'district':
                            aVal = a.properties.kecamatan || '';
                            bVal = b.properties.kecamatan || '';
                            break;
                        case 'victims':
                            aVal = a.properties.Jumlah_Korban || 0;
                            bVal = b.properties.Jumlah_Korban || 0;
                            break;
                        default:
                            return 0;
                    }
                    
                    if (typeof aVal === 'string') {
                        return sortDirection === 'asc' 
                            ? aVal.localeCompare(bVal) 
                            : bVal.localeCompare(aVal);
                    } else {
                        return sortDirection === 'asc' 
                            ? aVal - bVal 
                            : bVal - aVal;
                    }
                });
                
                // Update sort button icon
                sortBtn.innerHTML = sortDirection === 'asc' 
                    ? '<i class="ri-sort-asc"></i>' 
                    : '<i class="ri-sort-desc"></i>';
                    
                populateTable(filteredData, 1);
            };

            // Event listener untuk search
            searchInput.addEventListener('keyup', () => {
                const searchTerm = searchInput.value.toLowerCase();
                filteredData = allPointData.filter(feature => {
                    const props = feature.properties;
                    const location = (props.Nama_Pemetaan || props.jalan || '').toLowerCase();
                    const district = (props.kecamatan || '').toLowerCase();
                    return location.includes(searchTerm) || district.includes(searchTerm);
                });
                populateTable(filteredData, 1);
            });

            // Event listener untuk sort button
            sortBtn.addEventListener('click', () => {
                // Create a simple dropdown for sort options
                if (!document.getElementById('sortDropdown')) {
                    const dropdown = document.createElement('div');
                    dropdown.id = 'sortDropdown';
                    dropdown.className = 'dropdown-menu show';
                    dropdown.style.position = 'absolute';
                    dropdown.style.right = '0';
                    dropdown.style.top = '100%';
                    dropdown.innerHTML = `
                        <a class="dropdown-item" href="#" data-sort="type">Tipe</a>
                        <a class="dropdown-item" href="#" data-sort="location">Lokasi</a>
                        <a class="dropdown-item" href="#" data-sort="district">Kecamatan</a>
                        <a class="dropdown-item" href="#" data-sort="victims">Jumlah Korban</a>
                    `;
                    sortBtn.parentElement.appendChild(dropdown);
                    
                    // Add event listeners to sort options
                    dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            const field = this.getAttribute('data-sort');
                            sortData(field);
                            dropdown.remove();
                        });
                    });
                } else {
                    document.getElementById('sortDropdown').remove();
                }
            });

            // Event listener untuk filter button
            filterBtn.addEventListener('click', () => {
                // Create a simple filter modal
                if (!document.getElementById('filterModal')) {
                    const modal = document.createElement('div');
                    modal.id = 'filterModal';
                    modal.className = 'modal fade show';
                    modal.style.display = 'block';
                    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    modal.innerHTML = `
                        <div class="modal-dialog">
                            <div class="modal-content bg-dark text-light">
                                <div class="modal-header">
                                    <h5 class="modal-title">Filter Data</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Tipe</label>
                                        <select class="form-select bg-dark text-light" id="filterType">
                                            <option value="">Semua</option>
                                            <option value="banjir">Banjir</option>
                                            <option value="genangan">Genangan</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Kecamatan</label>
                                        <select class="form-select bg-dark text-light" id="filterDistrict">
                                            <option value="">Semua</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" id="resetFilter">Reset</button>
                                    <button type="button" class="btn btn-primary" id="applyFilter">Terapkan</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Populate district dropdown
                    const districts = new Set();
                    allPointData.forEach(feature => {
                        const district = feature.properties.kecamatan;
                        if (district) districts.add(district);
                    });
                    
                    const districtSelect = document.getElementById('filterDistrict');
                    Array.from(districts).sort().forEach(district => {
                        const option = document.createElement('option');
                        option.value = district;
                        option.textContent = district;
                        districtSelect.appendChild(option);
                    });
                    
                    // Event listeners
                    document.querySelector('#filterModal .btn-close').addEventListener('click', () => {
                        modal.remove();
                    });
                    
                    document.getElementById('resetFilter').addEventListener('click', () => {
                        document.getElementById('filterType').value = '';
                        document.getElementById('filterDistrict').value = '';
                        filteredData = [...allPointData];
                        populateTable(filteredData, 1);
                        modal.remove();
                    });
                    
                    document.getElementById('applyFilter').addEventListener('click', () => {
                        const typeFilter = document.getElementById('filterType').value;
                        const districtFilter = document.getElementById('filterDistrict').value;
                        
                        filteredData = allPointData.filter(feature => {
                            const props = feature.properties;
                            const type = props.Nama_Pemetaan ? 'banjir' : 'genangan';
                            const district = props.kecamatan || '';
                            
                            return (!typeFilter || type === typeFilter) && 
                                   (!districtFilter || district === districtFilter);
                        });
                        
                        populateTable(filteredData, 1);
                        modal.remove();
                    });
                }
            });

            // Initialize table with all data
            populateTable(filteredData);
        }

        function initializeMiniMap() {
            // Check if ol is available
            if (typeof ol === 'undefined') {
                console.error('OpenLayers is not loaded');
                return;
            }
            
            // Create mini map
            miniMap = new ol.Map({
                target: 'miniMap',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM({
                            url: 'https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png'
                        })
                    }),
                    new ol.layer.Vector({
                        source: new ol.source.Vector({
                            features: new ol.format.GeoJSON().readFeatures(banjirData, {
                                featureProjection: 'EPSG:3857'
                            })
                        }),
                        style: new ol.style.Style({
                            image: new ol.style.Icon({
                                anchor: [0.5, 1],
                                src: 'https://cdn-icons-png.flaticon.com/512/4470/4470326.png',
                                scale: 0.05
                            })
                        })
                    }),
                    new ol.layer.Vector({
                        source: new ol.source.Vector({
                            features: new ol.format.GeoJSON().readFeatures(genanganData, {
                                featureProjection: 'EPSG:3857'
                            })
                        }),
                        style: new ol.style.Style({
                            image: new ol.style.Icon({
                                anchor: [0.5, 1],
                                src: 'https://cdn-icons-png.flaticon.com/512/4151/4151021.png',
                                scale: 0.05
                            })
                        })
                    })
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([101.438309, 0.510440]),
                    zoom: 10
                }),
                controls: ol.control.defaults({
                    attribution: false,
                    zoom: false
                })
            });
            
            // Add interaction to show feature info on click
            miniMap.on('singleclick', function(evt) {
                const features = [];
                miniMap.forEachFeatureAtPixel(evt.pixel, function(feature) {
                    features.push(feature);
                });
                
                if (features.length > 0) {
                    const feature = features[0];
                    const props = feature.getProperties();
                    const type = props.Nama_Pemetaan ? 'Banjir' : 'Genangan';
                    const location = props.Nama_Pemetaan || props.jalan || '-';
                    const district = props.kecamatan || '-';
                    const victims = props.Jumlah_Korban || '-';
                    
                    // Create popup
                    const popup = document.createElement('div');
                    popup.className = 'ol-popup';
                    popup.innerHTML = `
                        <a href="#" class="ol-popup-closer"></a>
                        <div>
                            <h5>${type}</h5>
                            <p><strong>Lokasi:</strong> ${location}</p>
                            <p><strong>Kecamatan:</strong> ${district}</p>
                            <p><strong>Korban:</strong> ${victims}</p>
                        </div>
                    `;
                    
                    const overlay = new ol.Overlay({
                        element: popup,
                        autoPan: true,
                        autoPanAnimation: {
                            duration: 250
                        }
                    });
                    
                    miniMap.addOverlay(overlay);
                    overlay.setPosition(evt.coordinate);
                    
                    // Add close button functionality
                    popup.querySelector('.ol-popup-closer').onclick = function() {
                        miniMap.removeOverlay(overlay);
                        return false;
                    };
                }
            });
        }

        function showLoadingSpinner() {
            if (!document.getElementById('loadingSpinner')) {
                const spinner = document.createElement('div');
                spinner.id = 'loadingSpinner';
                spinner.className = 'd-flex justify-content-center align-items-center position-fixed';
                spinner.style.top = '0';
                spinner.style.left = '0';
                spinner.style.width = '100%';
                spinner.style.height = '100%';
                spinner.style.backgroundColor = 'rgba(0,0,0,0.7)';
                spinner.style.zIndex = '9999';
                spinner.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                `;
                document.body.appendChild(spinner);
            }
        }

        function hideLoadingSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.remove();
        }

        function updateMetricCard(id, value) {
            const element = document.getElementById(id);
            if (element) {
                // Animate the counter
                const current = parseInt(element.textContent) || 0;
                const increment = (value - current) / 20;
                let step = 0;
                
                const timer = setInterval(() => {
                    step++;
                    const newValue = Math.round(current + increment * step);
                    element.textContent = newValue;
                    
                    if (step >= 20) {
                        element.textContent = value;
                        clearInterval(timer);
                    }
                }, 50);
            }
        }

        function showFeatureDetails(feature) {
            const props = feature.properties;
            const type = props.Nama_Pemetaan ? 'Banjir' : 'Genangan';
            const location = props.Nama_Pemetaan || props.jalan || '-';
            const district = props.kecamatan || '-';
            const victims = props.Jumlah_Korban || '-';
            const coordinates = feature.geometry.coordinates;
            
            // Create detail modal
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content bg-dark text-light">
                        <div class="modal-header">
                            <h5 class="modal-title">Detail ${type}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Tipe</label>
                                <p class="form-control-plaintext">${type}</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Lokasi</label>
                                <p class="form-control-plaintext">${location}</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Kecamatan</label>
                                <p class="form-control-plaintext">${district}</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Jumlah Korban</label>
                                <p class="form-control-plaintext">${victims}</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Koordinat</label>
                                <p class="form-control-plaintext">${coordinates ? `${coordinates[1]}, ${coordinates[0]}` : '-'}</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                            <button type="button" class="btn btn-primary" id="showOnMap">Tampilkan di Peta</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Event listeners
            document.getElementById('showOnMap').addEventListener('click', () => {
                showFeatureOnMap(feature);
                modal.remove();
            });
            
            document.querySelectorAll('.btn-close, .btn-secondary').forEach(btn => {
                btn.addEventListener('click', () => modal.remove());
            });
        }

        function showFeatureOnMap(feature) {
            // Center map on feature
            const coordinates = feature.geometry.coordinates;
            if (coordinates && miniMap) {
                const view = miniMap.getView();
                view.animate({
                    center: ol.proj.fromLonLat([coordinates[0], coordinates[1]]),
                    zoom: 14,
                    duration: 1000
                });
                
                // Show popup for the feature
                const props = feature.properties;
                const type = props.Nama_Pemetaan ? 'Banjir' : 'Genangan';
                const location = props.Nama_Pemetaan || props.jalan || '-';
                const district = props.kecamatan || '-';
                const victims = props.Jumlah_Korban || '-';
                
                // Create popup
                const popup = document.createElement('div');
                popup.className = 'ol-popup';
                popup.innerHTML = `
                    <a href="#" class="ol-popup-closer"></a>
                    <div>
                        <h5>${type}</h5>
                        <p><strong>Lokasi:</strong> ${location}</p>
                        <p><strong>Kecamatan:</strong> ${district}</p>
                        <p><strong>Korban:</strong> ${victims}</p>
                    </div>
                `;
                
                const overlay = new ol.Overlay({
                    element: popup,
                    autoPan: true,
                    autoPanAnimation: {
                        duration: 250
                    }
                });
                
                miniMap.addOverlay(overlay);
                overlay.setPosition(ol.proj.fromLonLat([coordinates[0], coordinates[1]]));
                
                // Add close button functionality
                popup.querySelector('.ol-popup-closer').onclick = function() {
                    miniMap.removeOverlay(overlay);
                    return false;
                };
            }
        }

        function exportData() {
            // Create export modal
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content bg-dark text-light">
                        <div class="modal-header">
                            <h5 class="modal-title">Export Data</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>Pilih format export:</p>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-primary" id="exportJSON">Export sebagai JSON</button>
                                <button type="button" class="btn btn-outline-primary" id="exportCSV">Export sebagai CSV</button>
                                <button type="button" class="btn btn-outline-primary" id="exportGeoJSON">Export sebagai GeoJSON</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Event listeners
            document.getElementById('exportJSON').addEventListener('click', () => {
                exportAsJSON();
                modal.remove();
            });
            
            document.getElementById('exportCSV').addEventListener('click', () => {
                exportAsCSV();
                modal.remove();
            });
            
            document.getElementById('exportGeoJSON').addEventListener('click', () => {
                exportAsGeoJSON();
                modal.remove();
            });
            
            document.querySelectorAll('.btn-close, .btn-secondary').forEach(btn => {
                btn.addEventListener('click', () => modal.remove());
            });
        }

        function exportAsJSON() {
            // Get current filtered data
            const data = {
                banjir: banjirData,
                genangan: genanganData,
                riau: riauData,
                news: newsData,
                pekan: pekanData
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'floodguard-data.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showSuccessNotification('Data berhasil diekspor sebagai JSON');
        }

        function exportAsCSV() {
            // Create CSV content
            let csvContent = "Tipe,Lokasi,Kecamatan,Jumlah Korban\n";
            
            allPointData.forEach(feature => {
                const props = feature.properties;
                const type = props.Nama_Pemetaan ? 'Banjir' : 'Genangan';
                const location = props.Nama_Pemetaan || props.jalan || '';
                const district = props.kecamatan || '';
                const victims = props.Jumlah_Korban || '';
                
                csvContent += `"${type}","${location}","${district}","${victims}"\n`;
            });
            
            const dataUri = 'data:text/csv;charset=utf-8,'+ encodeURIComponent(csvContent);
            
            const exportFileDefaultName = 'floodguard-data.csv';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showSuccessNotification('Data berhasil diekspor sebagai CSV');
        }

        function exportAsGeoJSON() {
            // Combine all features into one GeoJSON
            const combinedData = {
                type: "FeatureCollection",
                features: [...banjirData.features, ...genanganData.features]
            };
            
            const dataStr = JSON.stringify(combinedData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'floodguard-geojson.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showSuccessNotification('Data berhasil diekspor sebagai GeoJSON');
        }

        function refreshData() {
            showLoadingSpinner();
            
            // Reload the page to refresh all data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        function refreshNews() {
            showLoadingSpinner();
            
            fetch('data/news.json')
                .then(res => {
                    if (!res.ok) throw new Error('Gagal memuat data berita');
                    return res.json();
                })
                .then(data => {
                    newsData = data;
                    populateNewsSection();
                    hideLoadingSpinner();
                    showSuccessNotification('Berita berhasil diperbarui');
                })
                .catch(error => {
                    console.error('Error refreshing news:', error);
                    showErrorNotification('Gagal memperbarui berita');
                    hideLoadingSpinner();
                });
        }

        function showSuccessNotification(message) {
            showNotification(message, 'success');
        }

        function showErrorNotification(message) {
            showNotification(message, 'danger');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3`;
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="me-2">
                        ${type === 'success' 
                            ? '<i class="ri-checkbox-circle-fill"></i>' 
                            : '<i class="ri-error-warning-fill"></i>'}
                    </div>
                    <div>${message}</div>
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
            
            // Add close button functionality
            notification.querySelector('.btn-close').addEventListener('click', () => {
                notification.remove();
            });
        }
    </script>
    <script type="module" src="/dashboard.js"></script>

    <!-- Navbar Component -->
<script type="module" src="/components/Navbar.js"></script>
</body>
</html>